echo 'Initialize variables...'

export BUILD_NUMBER=$bamboo_buildNumber
export BRANCH_NAME=$bamboo_planRepository_1_branch
export DOCKER_REGISTRY_PATH=$bamboo_vars_DOCKER_REGISTRY_PATH
export DOCKER_FILE=$bamboo_vars_DOCKER_FILE
export DOCKER_USER=$bamboo_vars_DOCKER_USER

export DOCKER_BIN="$(which docker)"
export DOCKER_TAG=""
export DOCKER_REGISTRY=""
export SERVICE_NAME=""

case $BRANCH_NAME in
  "master")
    SERVICE_NAME=$bamboo_vars_SERVICE_NAME
    DOCKER_REGISTRY=${bamboo_vars_DOCKER_REGISTRY_PROD}
    release_version="$(grep major release.properties | awk -F \= '{print $2}').$(grep minor release.properties | awk -F \= '{print $2}').$(grep patch release.properties | awk -F \= '{print $2}')"
    DOCKER_TAG="${DOCKER_REGISTRY}/${DOCKER_REGISTRY_PATH}/${SERVICE_NAME}/${release_version}:${SERVICE_NAME}-${release_version}.${BUILD_NUMBER}"
    ;;
  "beta")
    SERVICE_NAME=$bamboo_vars_SERVICE_NAME
    DOCKER_REGISTRY=${bamboo_vars_DOCKER_REGISTRY_BETA}
    echo "Building docker image for beta branch still not implemented. Exiting"
    exit 0
    ;;
  "develop")
    SERVICE_NAME=$bamboo_vars_SERVICE_NAME_DEV
    DOCKER_REGISTRY=${bamboo_vars_DOCKER_REGISTRY_DEV}
    DOCKER_TAG="${DOCKER_REGISTRY}/${DOCKER_REGISTRY_PATH}/${SERVICE_NAME}:latest"
    ;;
  *)
    echo "It's not stable branch. I don't want to build a docker image"
    exit 0
    ;;
esac
